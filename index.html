<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Market Insights</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --primary-color: #8db9ab;
      --primary-hover: #a9f9c5;
      --secondary-color: #64748b;
      --success-color: #006644;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --background-color: #f8fafc;
      --surface-color: #ffffff;
      --border-color: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      
      --font-family: 'Inter', system-ui, -apple-system, sans-serif;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      
      --transition-fast: 0.15s ease-in-out;
      --transition-normal: 0.25s ease-in-out;
    }
    
    body { 
      font-family: var(--font-family);
      background-color: var(--background-color);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .form-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    .form-section { 
      background: var(--surface-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .form-section:hover {
      box-shadow: var(--shadow-md);
    }
    
    .section-header {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .section-header i {
      color: var(--primary-color);
    }
    
    h1 {
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 1.75rem;
    }
    
    .main-content {
      flex: 1;
      padding: 2rem 0;
    }
    
    .main-header {
      text-align: center;
      margin-bottom: 2rem;
      background: var(--surface-color);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow-sm);
    }
    
    .main-header .icon {
      width: 60px;
      height: 60px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
      margin: 0 auto 1rem;
    }
    
    .subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 400;
    }
    
    .btn {
      border-radius: 8px;
      border: none;
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      transition: var(--transition);
      font-size: 0.875rem;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
      border: none;
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
      color: white;
    }
    
    .btn-success {
      background: var(--success-color);
      color: white;
      border: none;
    }
    
    .btn-success:hover {
      background: #004d33;
      color: white;
    }
    
    .btn-outline {
      background: var(--surface-color);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }
    
    .btn-outline:hover {
      background: var(--background-color);
      color: var(--text-primary);
      border-color: var(--primary-color);
    }
    
    .btn-outline-danger {
      background: var(--surface-color);
      color: var(--error-color);
      border: 2px solid var(--error-color);
    }
    
    .btn-outline-danger:hover {
      background: var(--error-color);
      color: white;
    }
    
    .btn:hover {
      transform: none;
      box-shadow: none;
    }
    
    .form-control, .form-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      background: var(--surface-color);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: all var(--transition-fast);
      appearance: none;
    }
    
    .form-control:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(141, 185, 171, 0.1);
    }
    
    .form-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-label i {
      color: var(--primary-color);
      font-size: 0.75rem;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .fade-in { 
      animation: fadeIn 0.8s ease-out forwards; 
      opacity: 0; 
    }
    
    @keyframes fadeIn { 
      to { opacity: 1; } 
    }
    
    .entry { 
      animation: slideInUp 0.4s ease;
      background: var(--card-bg);
    }
    
    @keyframes slideInUp {
      from { transform: translateY(50px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }
    
    .image-preview-container div { 
      position: relative; 
      width: 80px; 
      height: 80px; 
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .image-preview-container img { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      transition: var(--transition);
    }
    
    .image-preview-container img:hover {
      transform: scale(1.05);
    }
    
    .image-preview-container button {
      position: absolute; 
      top: 4px; 
      right: 4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
    }
    
    .language-selector {
      background: var(--surface-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      padding: 3rem;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .language-selector h2 {
      color: var(--text-primary);
      margin-bottom: 2rem;
      font-weight: 600;
      font-size: 1.5rem;
    }
    
    .loading-state {
      opacity: 0.7;
      pointer-events: none;
      position: relative;
    }
    
    .loading-state::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid #fff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .is-invalid {
      border-color: #dc3545 !important;
      animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .progress-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      z-index: 9999;
    }
    
    .progress-bar {
      height: 100%;
      background: var(--success-gradient);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    @media (max-width: 768px) {
      body { padding: 1rem; }
      h1 { font-size: 2rem; }
      .card { margin-bottom: 1.5rem; }
      .btn { padding: 10px 20px; }
      .main-header { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body>

  <!-- LANGUAGE SELECTOR -->
  <div id="languageSelector" class="d-flex flex-column align-items-center justify-content-center vh-100 text-center" style="background: linear-gradient(135deg, var(--primary-color) 0%, #6b7280 100%);">
    <div class="language-selector">
      <h2>Select Language / اختر اللغة</h2>
      <div class="d-flex gap-3 mt-3 justify-content-center">
        <button class="btn btn-primary" onclick="setLanguage('en')">🇺🇸 English</button>
        <button class="btn btn-primary" onclick="setLanguage('ar')">🇸🇦 العربية</button>
      </div>
    </div>
  </div>

  <!-- MAIN FORM -->
  <div class="app-container d-none" id="formContainer">
    <div class="main-content">
      <div class="form-container">
        <div class="main-header">
          <div class="icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h1>Market Insights</h1>
          <p class="subtitle">Competitor Pricing & Activities</p>
        </div>

        <!-- Top‐level info -->
        <section class="form-section">
          <h2 class="section-header">
            <i class="fas fa-map-marker-alt"></i>
            Visit Information
          </h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="address" class="form-label">
                <i class="fas fa-map-marker-alt"></i>
                Address
              </label>
              <input type="text" id="address" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="date" class="form-label">
                <i class="fas fa-calendar-alt"></i>
                Date
              </label>
              <input type="date" id="date" class="form-control" readonly required>
            </div>
            <div class="form-group">
              <label for="salesRep" class="form-label">
                <i class="fas fa-user-tie"></i>
                Sales Rep
              </label>
              <select id="salesRep" class="form-select">
            <option value="" disabled selected>-- Select --</option>
            <option>ABDULLAH IYAD AL-OBEIDI</option>
            <option>AMJAD NAZIM HUSSEIN</option>
            <option>AMMAR TAYSEER HASSAN</option>
            <option>ASAAD FAYEK MAHMOUD</option>
            <option>BALEEN OMER RASOL</option>
            <option>MURTADA KHALID KAMIL ABBAS</option>
            <option>MUSTAFA MAHDI JASSEM</option>
            <option>OMER ABD ALWAHAB</option>
            <option>OMER ALI MOHAMMED</option>
            <option>SALAH MAHDI SALEH</option>
            <option>WOROOD WALEED ABDULKAREEM MOHAMMED</option>
          </select>
            </div>
          </div>
        </section>

        <!-- Dynamic entries -->
        <div id="entries"></div>

        <!-- Action Buttons -->
        <section class="form-section">
          <h2 class="section-header">
            <i class="fas fa-cogs"></i>
            Actions
          </h2>
          <div class="d-grid mb-3">
            <button type="button" id="add-entry" class="btn btn-success">
              <i class="fas fa-plus me-2"></i>Add Entry
            </button>
          </div>
          <div class="row g-3 mb-4">
            <div class="col-6">
              <button type="button" id="preview" class="btn btn-primary w-100">
                <i class="fas fa-eye me-2"></i>Preview
              </button>
            </div>
            <div class="col-6">
              <button type="button" id="reset" class="btn btn-outline w-100">
                <i class="fas fa-undo me-2"></i>Reset
              </button>
            </div>
          </div>
          <div class="d-grid">
            <button id="submit" onclick="uploadAndSubmit()" class="btn btn-success btn-lg">
              <i class="fas fa-paper-plane me-2"></i>Submit Data
            </button>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- ENTRY TEMPLATE -->
  <template id="entry-template">
    <section class="form-section entry">
      <h2 class="section-header">
        <i class="fas fa-shopping-basket"></i>
        Product Entry
      </h2>
      <!-- 1) Classification → Supplier → Brand → Competitor Brand -->
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-tag"></i>
            Classification
          </label>
          <select name="classification" class="form-select" required>
            <!-- overridden in JS -->
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-building"></i>
            Supplier
          </label>
          <select name="supplier" class="form-select" disabled required></select>
        </div>
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-certificate"></i>
            Brand
          </label>
          <select name="brand" class="form-select" disabled required></select>
        </div>
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-star"></i>
            Competitor Brand
          </label>
          <select name="compBrand" class="form-select" disabled>
            <option value="" selected>-- Optional --</option>
          </select>
        </div>
      </div>

        </div>
        
        <!-- 2) Product Name & Product Size -->
        <div class="row g-3 mt-2">
        <div class="col-md-6 col-lg-4">
          <label class="form-label">Product Name</label>
          <input type="text" name="productName" class="form-control" required required>
        </div>
        <div class="col-md-6 col-lg-4">
          <label class="form-label">Product Size</label>
          <input type="text" name="productSize" class="form-control" required required>
        </div>
      </div>

        </div>
        
        <!-- 3) Activity Category → Activity → Prices -->
        <div class="row g-3 mt-2">
        <div class="col-md-3">
          <label class="form-label">Activity</label>
          <select name="activity" class="form-select" disabled required required></select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Retail Price</label>
          <input type="number" name="price" class="form-control" required required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Promo Price</label>
          <input type="number" name="promo" class="form-control">
        </div>
      </div>

        </div>
        
        <!-- 4) Visibility → Facings → Upload -->
        <div class="row g-3 mt-2">
        <div class="col-md-3">
          <label class="form-label">Visibility</label>
          <select name="visibility" class="form-select" required required>
            <!-- overridden in JS -->
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Facing Count</label>
          <input type="number" name="facing" class="form-control" required required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Upload Shelf Photos</label>
          <input type="file" name="images" class="form-control images-input" accept="image/*" multiple>
          <div class="image-preview-container d-flex flex-wrap gap-2 mt-2"></div>
        </div>
      </div>

        <!-- Remove button -->
        <div class="d-flex justify-content-end mt-4">
          <button type="button" class="btn btn-outline-danger remove-entry">
            <i class="fas fa-trash me-2"></i>Remove Entry
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- load your data arrays -->
  <script src="js/competitorData.js"></script>
  <script src="js/activityData.js"></script>

  <!-- main logic with classification/visibility translation -->
  <script>
    const translations = {
      en: {
        dir: 'ltr', 
        title: "Market Insights",
        subtitle: "Competitor Pricing & Activities",
        visitInfo: "Visit Information",
        productEntry: "Product Entry",
        actions: "Actions",
        address: "Address", 
        date: "Date", 
        salesRep: "Sales Rep",
        addEntry: "Add Entry", 
        preview: "Preview", 
        reset: "Reset",
        submit: "Submit Data",
        remove: "Remove Entry", 
        selectPlaceholder: "-- Select --",
        optionalPlaceholder: "-- Optional --",
        options: {
          classification: ["Food","Non Food"],
          visibility: ["Shelf","Block"]
        },
        labels: {
          classification: "Classification", 
          supplier: "Supplier", 
          brand: "Brand",
          compBrand: "Competitor Brand", 
          productName: "Product Name",
          productSize: "Product Size", 
          activity: "Activity", 
          price: "Retail Price", 
          promo: "Promo Price",
          visibility: "Visibility", 
          facing: "Facing Count",
          images: "Upload Shelf Photos"
        }
      },
      ar: {
        dir: 'rtl', 
        title: "رؤى السوق",
        subtitle: "أسعار ونشاطات المنافسين",
        visitInfo: "معلومات الزيارة",
        productEntry: "إدخال المنتج",
        actions: "الإجراءات",
        address: "العنوان", 
        date: "التاريخ", 
        salesRep: "مندوب المبيعات",
        addEntry: "إضافة مدخل", 
        preview: "معاينة", 
        reset: "إعادة ضبط",
        submit: "إرسال البيانات",
        remove: "إزالة المدخل", 
        selectPlaceholder: "-- اختر --",
        optionalPlaceholder: "-- اختياري --",
        options: {
         classification: ["غذائية","غير غذائية"], 
         visibility: ["رف","بلوك"] 
        },
        labels: {
          classification: "التصنيف", 
          supplier: "المورد", 
          brand: "العلامة التجارية",
          compBrand: "علامة المنافس", 
          productName: "اسم المنتج",
          productSize: "حجم المنتج", 
          activity: "النشاط", 
          price: "سعر البيع", 
          promo: "سعر العرض",
          visibility: "مكان الظهور", 
          facing: "عدد الواجهات",
          images: "تحميل صور الرف"
        }
      }
    };

    let currentLang = 'en';
    function setLanguage(lang) {
      currentLang = lang;
      const t = translations[lang];
      document.body.setAttribute('dir', t.dir);
      document.body.style.textAlign = t.dir==='rtl'?'right':'left';
      document.getElementById('languageSelector').classList.add('d-none');
      const form = document.getElementById('formContainer');
      form.classList.remove('d-none'); form.classList.add('fade-in');

      // top‐level labels
      document.querySelector('h1').textContent = t.title;
      document.querySelector('.subtitle').textContent = t.subtitle;
      
      // Visit Information section
      document.querySelector('label[for="address"]').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${t.address}`;
      document.querySelector('label[for="date"]').innerHTML = `<i class="fas fa-calendar-alt"></i> ${t.date}`;
      document.querySelector('label[for="salesRep"]').innerHTML = `<i class="fas fa-user-tie"></i> ${t.salesRep}`;
      
      // Section headers
      const visitHeader = document.querySelector('.form-section h2');
      if(visitHeader) visitHeader.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${t.visitInfo}`;
      
      const actionsHeader = document.querySelector('.form-section:last-of-type h2');
      if(actionsHeader) actionsHeader.innerHTML = `<i class="fas fa-cogs"></i> ${t.actions}`;
      
      // Buttons
      document.getElementById('add-entry').innerHTML = `<i class="fas fa-plus me-2"></i>${t.addEntry}`;
      document.getElementById('preview').innerHTML = `<i class="fas fa-eye me-2"></i>${t.preview}`;
      document.getElementById('reset').innerHTML = `<i class="fas fa-undo me-2"></i>${t.reset}`;
      document.getElementById('submit').innerHTML = `<i class="fas fa-paper-plane me-2"></i>${t.submit}`;

      // translate static SalesRep placeholder
      const repSel = document.getElementById('salesRep');
      if(repSel&&repSel.options.length) repSel.options[0].textContent = t.selectPlaceholder;
    }

    function fillSelect(sel, arr) {
      sel.innerHTML = `<option value="" disabled selected>${translations[currentLang].selectPlaceholder}</option>`
                    + arr.map(v=>`<option>${v}</option>`).join('');
    }

    // Global variables for entry management
    let entriesEl, tmpl;
    
    document.addEventListener('DOMContentLoaded', () => {
      // set today's date
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      entriesEl = document.getElementById('entries');
      tmpl = document.getElementById('entry-template').content;
    });

    // Global addEntry function
    function addEntry() {
      if (!entriesEl || !tmpl) {
        entriesEl = document.getElementById('entries');
        tmpl = document.getElementById('entry-template').content;
      }
        const clone = tmpl.cloneNode(true);
        const entry = clone.querySelector('.entry');
        const t     = translations[currentLang];

        // selects & inputs
        const cls = entry.querySelector('select[name=classification]');
        const sup = entry.querySelector('select[name=supplier]');
        const br  = entry.querySelector('select[name=brand]');
        const cb  = entry.querySelector('select[name=compBrand]');
        const pn  = entry.querySelector('input[name=productName]');
        const ps  = entry.querySelector('input[name=productSize]');        const act = entry.querySelector('select[name=activity]');
        const vis = entry.querySelector('select[name=visibility]');
        fillSelect(act, activityData.map(r => r.Activity));
        act.disabled = false;

        // 1) override classification options (value=English, text=translated)
        cls.innerHTML = `<option value="" disabled selected>${t.selectPlaceholder}</option>`
                      + translations.en.options.classification
                          .map((eng,i)=>
                             `<option value="${eng}">${t.options.classification[i]}</option>`
                          ).join('');

        // 2) override visibility options
        vis.innerHTML = `<option value="" disabled selected>${t.selectPlaceholder}</option>`
                      + translations.en.options.visibility
                          .map((eng,i)=>
                             `<option value="${eng}">${t.options.visibility[i]}</option>`
                          ).join('');

        // translate entry header
        const entryHeader = entry.querySelector('h2');
        if(entryHeader) entryHeader.innerHTML = `<i class="fas fa-shopping-basket"></i> ${t.productEntry}`;
        
        // translate all labels in entry
        const fieldMap = {
          "Classification":"classification","Supplier":"supplier","Brand":"brand",
          "Competitor Brand":"compBrand","Product Name":"productName",
          "Product Size":"productSize","Activity":"activity",
          "Retail Price":"price","Promo Price":"promo","Visibility":"visibility",
          "Facing Count":"facing","Upload Shelf Photos":"images"
        };
        entry.querySelectorAll('label').forEach(lbl => {
          const textContent = lbl.textContent.trim();
          const key = fieldMap[textContent];
          if(key) {
            const icon = lbl.querySelector('i');
            const iconHtml = icon ? icon.outerHTML : '';
            lbl.innerHTML = `${iconHtml} ${t.labels[key]}`;
          }
        });
        
        // translate placeholders
        const compBrandSelect = entry.querySelector('select[name="compBrand"]');
        if(compBrandSelect && compBrandSelect.options[0]) {
          compBrandSelect.options[0].textContent = t.optionalPlaceholder;
        }

        // populate Activity Category
        // cascading selects
        cls.addEventListener('change', () => {
          fillSelect(sup,
            [...new Set(competitorData.filter(r => r.Classification === cls.value).map(r => r.Supplier))].sort()
          );
          sup.disabled = false;
          br.innerHTML = `<option value="" disabled selected>${translations[currentLang].selectPlaceholder}</option>`;
          br.disabled = true;
          cb.innerHTML = `<option value="">${translations[currentLang].optionalPlaceholder}</option>`;
          cb.disabled = true;
        });

        sup.addEventListener('change', () => {
          fillSelect(br,
            [...new Set(competitorData.filter(r => r.Supplier === sup.value).map(r => r.Brand))].sort()
          );
          br.disabled = false;
          cb.innerHTML = `<option value="">${translations[currentLang].optionalPlaceholder}</option>`;
          cb.disabled = true;
        });

        br.addEventListener('change', () => {
          const compBrands = [...new Set(competitorData
            .filter(r => r.Supplier === sup.value && r.Brand === br.value)
            .map(r => r["Competitor Brand"])
          )].sort();
          cb.innerHTML = `<option value="">${translations[currentLang].optionalPlaceholder}</option>` + compBrands.map(b => `<option>${b}</option>`).join('');
          cb.disabled = false;
        });
        // remove-entry
        entry.querySelector('.remove-entry').onclick = () => entry.remove();
        entry.querySelector('.remove-entry').innerHTML = `<i class="fas fa-trash me-2"></i>${t.remove}`;

        // multi-image preview logic
        const imagesInput      = entry.querySelector('.images-input');
        const previewContainer = entry.querySelector('.image-preview-container');
        const dt = new DataTransfer();

        imagesInput.addEventListener('change', () => {
          for(const file of imagesInput.files) dt.items.add(file);
          imagesInput.files = dt.files;
          renderPreviews();
        });
        function renderPreviews() {
          previewContainer.innerHTML = '';
          Array.from(dt.files).forEach((file, idx) => {
            const reader = new FileReader();
            const wrapper= document.createElement('div');
            const img    = document.createElement('img');
            const btn    = document.createElement('button');
            img.classList.add('border','rounded');
            btn.type = 'button'; btn.innerHTML = '×';
            btn.classList.add('btn','btn-sm','btn-danger');
            btn.addEventListener('click', () => {
              dt.items.remove(idx);
              imagesInput.files = dt.files;
              renderPreviews();
            });
            reader.onload = e => img.src = e.target.result;
            reader.readAsDataURL(file);
            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            previewContainer.appendChild(wrapper);
          });
        }

      entriesEl.appendChild(entry);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Attach event listeners
      document.getElementById('add-entry').onclick = addEntry;
      document.getElementById('reset').onclick = () => location.reload();
      
      // Add first entry by default
      addEntry();
    });

    function showPreview() {
        const t = translations[currentLang];

        // build mapping English→translated for preview
        const clsMap = Object.fromEntries(
          translations.en.options.classification.map((eng,i)=>[eng, t.options.classification[i]])
        );
        const visMap = Object.fromEntries(
          translations.en.options.visibility.map((eng,i)=>[eng, t.options.visibility[i]])
        );

        const address  = document.getElementById('address').value.trim();
        const date     = document.getElementById('date').value;
        const salesRep = document.getElementById('salesRep').value;

        const collected = Array.from(entriesEl.children).map((entry, i) => {
          return {
            classification: clsMap[entry.querySelector('select[name="classification"]').value] || '',
            supplier:       entry.querySelector('select[name="supplier"]').value,
            brand:          entry.querySelector('select[name="brand"]').value,
            compBrand:      entry.querySelector('select[name="compBrand"]').value,
            productName:    entry.querySelector('input[name="productName"]').value,
            productSize:    entry.querySelector('input[name="productSize"]').value,
            actCat:         entry.querySelector('select[name="actCat"]').value,
            activity:       entry.querySelector('select[name="activity"]').value,
            price:          entry.querySelector('input[name="price"]').value,
            promo:          entry.querySelector('input[name="promo"]').value,
            visibility:     visMap[entry.querySelector('select[name="visibility"]').value] || '',
            facing:         entry.querySelector('input[name="facing"]').value,
            images:         Array.from(entry.querySelector('input[name="images"]').files).map(f=>f.name)
          };
        });

        // render preview
        let html = `<div class="mt-4" id="previewContainer">
                      <h3>${t.preview}</h3>
                      <p><strong>${t.address}:</strong> ${address}<br/>
                         <strong>${t.date}:</strong> ${date}<br/>
                         <strong>${t.salesRep}:</strong> ${salesRep}</p>`;
        collected.forEach((e, idx) => {
          html += `<div class="card p-3 mb-2">
                     <h5>${t.preview} Entry ${idx+1}</h5><ul>
                       <li>${t.labels.classification}: ${e.classification}</li>
                       <li>${t.labels.supplier}: ${e.supplier}</li>
                       <li>${t.labels.brand}: ${e.brand}</li>
                       <li>${t.labels.compBrand}: ${e.compBrand}</li>
                       <li>${t.labels.productName}: ${e.productName}</li>
                       <li>${t.labels.productSize}: ${e.productSize}</li>
                       <li>${t.labels.activity}: ${e.activity}</li>
                       <li>${t.labels.price}: ${e.price}</li>
                       <li>${t.labels.promo}: ${e.promo}</li>
                       <li>${t.labels.visibility}: ${e.visibility}</li>
                       <li>${t.labels.facing}: ${e.facing}</li>
                       <li>${t.labels.images}: ${e.images.join(', ')}</li>
                     </ul>
                   </div>`;
        });
        html += `</div>`;

        const old = document.getElementById('previewContainer');
        if(old) old.remove();
        document.getElementById('formContainer').insertAdjacentHTML('beforeend', html);
        document.getElementById('previewContainer').scrollIntoView({behavior:'smooth'});
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('preview').onclick = showPreview;
    });
  </script>
  <script src="js/submit.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
